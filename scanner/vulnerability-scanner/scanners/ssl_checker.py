# scanners/ssl_checker.py
"""
SSL/TLS Checker
ตรวจสอบ SSL/TLS configuration และ certificate
"""

import ssl
import socket
from urllib.parse import urlparse
from datetime import datetime


class SSLChecker:
    def __init__(self):
        """Initialize SSL/TLS Checker"""
        # Insecure SSL/TLS versions
        self.insecure_versions = [
            'SSLv2',
            'SSLv3',
            'TLSv1',
            'TLSv1.1'
        ]
    
    def scan(self, url):
        """
        ตรวจสอบ SSL/TLS configuration
        
        Args:
            url (str): URL ที่จะตรวจสอบ
            
        Returns:
            list: รายการช่องโหว่ที่พบ
        """
        vulnerabilities = []
        
        print(f"\n[SSL] Checking {url}...")
        
        try:
            # 1. Parse URL
            parsed = urlparse(url)
            
            # ถ้าไม่มี scheme ให้เพิ่ม https://
            if not parsed.scheme:
                url = 'https://' + url
                parsed = urlparse(url)
            
            hostname = parsed.netloc or parsed.path
            
            # ลบ port ออก (ถ้ามี)
            if ':' in hostname:
                hostname = hostname.split(':')[0]
            
            print(f"[SSL] Target: {hostname}")
            
            # 2. เช็คว่าใช้ HTTPS หรือไม่
            if parsed.scheme == 'http':
                print(f"[SSL] ✓ Warning: Site uses HTTP (not HTTPS)")
                vulnerabilities.append({
                    'type': 'Missing HTTPS',
                    'severity': 'High',
                    'url': url,
                    'description': 'Website does not use HTTPS encryption',
                    'recommendation': 'Enable HTTPS to encrypt data in transit'
                })
                # ถ้าไม่มี HTTPS ก็ไม่ต้องเช็ค SSL certificate
                return vulnerabilities
            
            # 3. เช็ค SSL certificate
            cert_info = self._get_certificate_info(hostname)
            
            if not cert_info:
                print(f"[SSL] ✗ Could not retrieve SSL certificate")
                vulnerabilities.append({
                    'type': 'SSL Certificate Error',
                    'severity': 'High',
                    'url': url,
                    'description': 'Could not retrieve or validate SSL certificate',
                    'recommendation': 'Check SSL certificate installation and configuration'
                })
                return vulnerabilities
            
            # 4. ตรวจสอบ certificate expiration
            vuln = self._check_certificate_expiration(url, cert_info)
            if vuln:
                vulnerabilities.append(vuln)
            
            # 5. ตรวจสอบ SSL/TLS version
            vuln = self._check_ssl_version(hostname)
            if vuln:
                vulnerabilities.append(vuln)
            
            # 6. รายงานสถานะ
            if len(vulnerabilities) == 0:
                print(f"[SSL] ✓ SSL/TLS configuration is secure")
                vulnerabilities.append({
                    'type': 'SSL/TLS Information',
                    'severity': 'Info',
                    'url': url,
                    'certificate': {
                        'subject': cert_info.get('subject', 'N/A'),
                        'issuer': cert_info.get('issuer', 'N/A'),
                        'valid_from': cert_info.get('notBefore', 'N/A'),
                        'valid_to': cert_info.get('notAfter', 'N/A')
                    },
                    'description': 'SSL/TLS is properly configured',
                    'recommendation': 'Continue monitoring certificate expiration'
                })
            
            print(f"[SSL] Found {len(vulnerabilities)} issues")
            
        except Exception as e:
            print(f"[SSL] Error: {e}")
        
        return vulnerabilities
    
    def _get_certificate_info(self, hostname, port=443):
        """ดึงข้อมูล SSL certificate"""
        try:
            # สร้าง SSL context
            context = ssl.create_default_context()
            
            # เชื่อมต่อและดึง certificate
            with socket.create_connection((hostname, port), timeout=10) as sock:
                with context.wrap_socket(sock, server_hostname=hostname) as ssock:
                    cert = ssock.getpeercert()
                    return cert
            
        except ssl.SSLError as e:
            print(f"[SSL] SSL Error: {e}")
            return None
        except socket.gaierror:
            print(f"[SSL] Cannot resolve hostname: {hostname}")
            return None
        except Exception as e:
            print(f"[SSL] Error getting certificate: {e}")
            return None
    
    def _check_certificate_expiration(self, url, cert_info):
        """ตรวจสอบว่า certificate หมดอายุหรือใกล้หมดอายุ"""
        try:
            # ดึงวันหมดอายุ
            not_after = cert_info.get('notAfter')
            
            if not not_after:
                return None
            
            # Parse วันที่
            # Format: 'Jan 1 00:00:00 2025 GMT'
            expiry_date = datetime.strptime(not_after, '%b %d %H:%M:%S %Y %Z')
            
            # คำนวณจำนวนวันที่เหลือ
            days_remaining = (expiry_date - datetime.now()).days
            
            print(f"[SSL] Certificate expires in {days_remaining} days")
            
            # ถ้าหมดอายุแล้ว
            if days_remaining < 0:
                print(f"[SSL] ✓ Certificate has EXPIRED!")
                return {
                    'type': 'Expired SSL Certificate',
                    'severity': 'Critical',
                    'url': url,
                    'expiry_date': not_after,
                    'days_expired': abs(days_remaining),
                    'description': f'SSL certificate expired {abs(days_remaining)} days ago',
                    'recommendation': 'Renew SSL certificate immediately'
                }
            
            # ถ้าใกล้หมดอายุ (น้อยกว่า 30 วัน)
            elif days_remaining < 30:
                print(f"[SSL] ✓ Certificate expires soon!")
                return {
                    'type': 'SSL Certificate Expiring Soon',
                    'severity': 'Medium',
                    'url': url,
                    'expiry_date': not_after,
                    'days_remaining': days_remaining,
                    'description': f'SSL certificate expires in {days_remaining} days',
                    'recommendation': 'Renew SSL certificate before expiration'
                }
            
            else:
                print(f"[SSL] ✗ Certificate is valid")
            
        except Exception as e:
            print(f"[SSL] Error checking expiration: {e}")
        
        return None
    
    def _check_ssl_version(self, hostname, port=443):
        """ตรวจสอบ SSL/TLS version"""
        try:
            # ลอง connect ด้วย TLS versions ต่างๆ
            # เช็คว่าสามารถใช้ insecure versions ได้หรือไม่
            
            for version_name in self.insecure_versions:
                if self._test_ssl_version(hostname, port, version_name):
                    print(f"[SSL] ✓ Insecure {version_name} is supported!")
                    return {
                        'type': 'Insecure SSL/TLS Version',
                        'severity': 'Medium',
                        'hostname': hostname,
                        'insecure_version': version_name,
                        'description': f'Server supports insecure {version_name}',
                        'recommendation': f'Disable {version_name} and use TLS 1.2 or higher only'
                    }
            
            print(f"[SSL] ✗ Only secure TLS versions are supported")
            
        except Exception as e:
            print(f"[SSL] Error checking SSL version: {e}")
        
        return None
    
    def _test_ssl_version(self, hostname, port, version_name):
        """ทดสอบว่า server รองรับ SSL/TLS version นี้หรือไม่"""
        try:
            # Map version name to ssl constant
            version_map = {
                'SSLv2': ssl.PROTOCOL_SSLv23,  # SSLv2 is deprecated
                'SSLv3': ssl.PROTOCOL_SSLv23,  # SSLv3 is deprecated
                'TLSv1': ssl.PROTOCOL_TLSv1 if hasattr(ssl, 'PROTOCOL_TLSv1') else None,
                'TLSv1.1': ssl.PROTOCOL_TLSv1_1 if hasattr(ssl, 'PROTOCOL_TLSv1_1') else None
            }
            
            protocol = version_map.get(version_name)
            
            if protocol is None:
                return False
            
            # พยายาม connect
            context = ssl.SSLContext(protocol)
            context.check_hostname = False
            context.verify_mode = ssl.CERT_NONE
            
            with socket.create_connection((hostname, port), timeout=5) as sock:
                with context.wrap_socket(sock) as ssock:
                    return True
            
        except:
            return False


# ทดสอบ scanner
if __name__ == "__main__":
    print("="*50)
    print("SSL/TLS Checker - Test")
    print("="*50)
    
    checker = SSLChecker()
    
    # ทดสอบกับหลาย URLs
    test_urls = [
        "https://www.google.com",
        # "http://testphp.vulnweb.com",  # HTTP (no HTTPS)
    ]
    
    for test_url in test_urls:
        results = checker.scan(test_url)
        
        print("\n" + "="*50)
        print(f"Results for {test_url}:")
        print("="*50)
        
        if len(results) == 0:
            print("\n✓ No issues found")
        else:
            for vuln in results:
                severity_icon = '✗' if vuln['severity'] in ['High', 'Critical', 'Medium'] else 'ℹ'
                print(f"\n{severity_icon} {vuln['type']}")
                if 'url' in vuln:
                    print(f"  URL: {vuln['url']}")
                if 'hostname' in vuln:
                    print(f"  Hostname: {vuln['hostname']}")
                if 'expiry_date' in vuln:
                    print(f"  Expiry Date: {vuln['expiry_date']}")
                if 'days_remaining' in vuln:
                    print(f"  Days Remaining: {vuln['days_remaining']}")
                if 'days_expired' in vuln:
                    print(f"  Days Expired: {vuln['days_expired']}")
                if 'insecure_version' in vuln:
                    print(f"  Insecure Version: {vuln['insecure_version']}")
                if 'certificate' in vuln:
                    print(f"  Certificate Info:")
                    for key, value in vuln['certificate'].items():
                        print(f"    {key}: {value}")
                print(f"  Severity: {vuln['severity']}")
                if 'description' in vuln:
                    print(f"  Description: {vuln['description']}")
                if 'recommendation' in vuln:
                    print(f"  Recommendation: {vuln['recommendation']}")