# scanners/port_scanner.py
"""
Port Scanner
สแกนหา open ports และ services ที่รันอยู่บนเซิร์ฟเวอร์
"""

import socket
from urllib.parse import urlparse


class PortScanner:
    def __init__(self):
        """Initialize Port Scanner"""
        # Common ports และ services
        self.common_ports = {
            21: 'FTP',
            22: 'SSH',
            23: 'Telnet',
            25: 'SMTP',
            53: 'DNS',
            80: 'HTTP',
            110: 'POP3',
            143: 'IMAP',
            443: 'HTTPS',
            445: 'SMB',
            3306: 'MySQL',
            3389: 'RDP',
            5432: 'PostgreSQL',
            5900: 'VNC',
            8080: 'HTTP-Proxy',
            8443: 'HTTPS-Alt'
        }
        
        # Risky ports (ไม่ควรเปิดไว้)
        self.risky_ports = {
            21: 'FTP is insecure, use SFTP instead',
            23: 'Telnet is insecure, use SSH instead',
            3389: 'RDP is vulnerable to brute force attacks',
            5900: 'VNC can be insecure if not properly configured'
        }
    
    def scan(self, url, ports_to_scan=None):
        """
        สแกน ports บน target host
        
        Args:
            url (str): URL หรือ hostname ที่จะสแกน
            ports_to_scan (list): list ของ ports ที่จะสแกน (ถ้าไม่ระบุจะใช้ common ports)
            
        Returns:
            list: รายการช่องโหว่ที่พบ
        """
        vulnerabilities = []
        
        print(f"\n[Port] Scanning {url}...")
        
        try:
            # 1. ดึง hostname จาก URL
            hostname = self._get_hostname(url)
            print(f"[Port] Target: {hostname}")
            
            # 2. กำหนด ports ที่จะสแกน
            if ports_to_scan is None:
                ports_to_scan = list(self.common_ports.keys())
            
            print(f"[Port] Scanning {len(ports_to_scan)} ports...")
            
            # 3. สแกนแต่ละ port
            open_ports = []
            for port in ports_to_scan:
                if self._is_port_open(hostname, port):
                    open_ports.append(port)
                    service = self.common_ports.get(port, 'Unknown')
                    print(f"[Port] ✓ Port {port} ({service}) is OPEN")
            
            # 4. สร้างรายงาน
            print(f"[Port] Found {len(open_ports)} open ports")
            
            # 5. ตรวจสอบ risky ports
            for port in open_ports:
                if port in self.risky_ports:
                    service = self.common_ports.get(port, 'Unknown')
                    risk_desc = self.risky_ports[port]
                    
                    vulnerabilities.append({
                        'type': 'Insecure Port Open',
                        'severity': 'Medium',
                        'port': port,
                        'service': service,
                        'host': hostname,
                        'description': f'Port {port} ({service}) is open: {risk_desc}',
                        'recommendation': f'Close port {port} or secure the {service} service properly'
                    })
            
            # 6. รายงาน open ports ทั้งหมด (เพื่อให้ข้อมูล)
            if open_ports:
                vulnerabilities.append({
                    'type': 'Open Ports Information',
                    'severity': 'Info',
                    'host': hostname,
                    'open_ports': open_ports,
                    'services': {port: self.common_ports.get(port, 'Unknown') for port in open_ports},
                    'description': f'Found {len(open_ports)} open ports on {hostname}',
                    'recommendation': 'Review all open ports and close unnecessary ones'
                })
            
            print(f"[Port] Found {len(vulnerabilities)} issues")
            
        except Exception as e:
            print(f"[Port] Error: {e}")
        
        return vulnerabilities
    
    def _get_hostname(self, url):
        """ดึง hostname จาก URL"""
        try:
            # ถ้าไม่มี scheme ให้เพิ่ม http://
            if not url.startswith(('http://', 'https://')):
                url = 'http://' + url
            
            parsed = urlparse(url)
            hostname = parsed.netloc or parsed.path
            
            # ลบ port ออก (ถ้ามี)
            if ':' in hostname:
                hostname = hostname.split(':')[0]
            
            return hostname
            
        except Exception as e:
            print(f"[Error] Cannot parse URL: {e}")
            return url
    
    def _is_port_open(self, hostname, port, timeout=2):
        """ตรวจสอบว่า port เปิดอยู่หรือไม่"""
        try:
            # สร้าง socket
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)
            
            # พยายาม connect
            result = sock.connect_ex((hostname, port))
            sock.close()
            
            # result == 0 = connect สำเร็จ = port เปิดอยู่
            return result == 0
            
        except socket.gaierror:
            # ไม่สามารถ resolve hostname
            print(f"[Error] Cannot resolve hostname: {hostname}")
            return False
        except socket.error:
            return False
        except Exception as e:
            print(f"[Error] Checking port {port}: {e}")
            return False


# ทดสอบ scanner
if __name__ == "__main__":
    print("="*50)
    print("Port Scanner - Test")
    print("="*50)
    
    scanner = PortScanner()
    
    # ทดสอบกับ scanme.nmap.org (เซิร์ฟเวอร์ที่อนุญาตให้สแกนได้)
    # หรือ localhost
    test_target = "scanme.nmap.org"
    # test_target = "localhost"  # ลองใช้ localhost ถ้าอยากทดสอบกับเครื่องตัวเอง
    
    # สแกนแค่บาง ports เพื่อประหยัดเวลา
    ports_to_test = [21, 22, 23, 80, 443, 3306, 3389, 8080]
    
    results = scanner.scan(test_target, ports_to_scan=ports_to_test)
    
    print("\n" + "="*50)
    print("Results:")
    print("="*50)
    
    if len(results) == 0:
        print("\n✓ No issues found")
    else:
        for vuln in results:
            print(f"\n{'✗' if vuln['severity'] != 'Info' else 'ℹ'} {vuln['type']}")
            if 'host' in vuln:
                print(f"  Host: {vuln['host']}")
            if 'port' in vuln:
                print(f"  Port: {vuln['port']}")
            if 'service' in vuln:
                print(f"  Service: {vuln['service']}")
            if 'open_ports' in vuln:
                print(f"  Open Ports: {vuln['open_ports']}")
            if 'services' in vuln:
                print(f"  Services: {vuln['services']}")
            print(f"  Severity: {vuln['severity']}")
            if 'description' in vuln:
                print(f"  Description: {vuln['description']}")
            if 'recommendation' in vuln:
                print(f"  Recommendation: {vuln['recommendation']}")