# scanners/outdated_deps.py
"""
Outdated Dependencies Scanner
ตรวจสอบว่า dependencies มีเวอร์ชันเก่าหรือมีช่องโหว่ที่รู้จัก
"""

import requests
import re
import json
from packaging import version


class OutdatedDepsScanner:
    def __init__(self):
        """Initialize Outdated Dependencies Scanner"""
        # PyPI API endpoint
        self.pypi_api = "https://pypi.org/pypi/{package}/json"
        
        # Known vulnerable versions (ตัวอย่าง - ในโลกจริงควรใช้ CVE database)
        self.known_vulnerabilities = {
            'flask': {
                '2.0.0': 'CVE-2023-30861: Security issue in session handling',
                '2.0.1': 'CVE-2023-30861: Security issue in session handling'
            },
            'requests': {
                '2.25.0': 'CVE-2023-32681: Potential security issue',
                '2.26.0': 'CVE-2023-32681: Potential security issue'
            },
            'django': {
                '3.0.0': 'Multiple CVEs: SQL injection and XSS vulnerabilities',
                '3.1.0': 'CVE-2021-35042: Potential SQL injection'
            }
        }
    
    def scan(self, requirements_file='requirements.txt'):
        """
        สแกน dependencies จากไฟล์ requirements.txt
        
        Args:
            requirements_file (str): path ไปยังไฟล์ requirements.txt
            
        Returns:
            list: รายการช่องโหว่ที่พบ
        """
        vulnerabilities = []
        
        print(f"\n[Deps] Scanning dependencies from {requirements_file}...")
        
        try:
            # 1. อ่าน requirements.txt
            dependencies = self._read_requirements(requirements_file)
            print(f"[Deps] Found {len(dependencies)} dependencies")
            
            # 2. ตรวจสอบแต่ละ dependency
            for i, (package, current_version) in enumerate(dependencies.items()):
                print(f"[Deps] Checking {package} ({current_version})... [{i+1}/{len(dependencies)}]")
                
                # 2.1 เช็คว่ามี known vulnerability หรือไม่
                vuln = self._check_known_vulnerability(package, current_version)
                if vuln:
                    vulnerabilities.append(vuln)
                
                # 2.2 เช็คว่ามีเวอร์ชันใหม่หรือไม่
                vuln = self._check_outdated(package, current_version)
                if vuln:
                    vulnerabilities.append(vuln)
            
            print(f"[Deps] Found {len(vulnerabilities)} issues")
            
        except FileNotFoundError:
            print(f"[Deps] Error: {requirements_file} not found")
        except Exception as e:
            print(f"[Deps] Error: {e}")
        
        return vulnerabilities
    
    def _read_requirements(self, requirements_file):
        """อ่านไฟล์ requirements.txt"""
        dependencies = {}
        
        try:
            with open(requirements_file, 'r') as f:
                for line in f:
                    line = line.strip()
                    
                    # ข้ามบรรทัดว่างและ comments
                    if not line or line.startswith('#'):
                        continue
                    
                    # Parse package==version
                    match = re.match(r'([a-zA-Z0-9\-_]+)==([0-9\.]+)', line)
                    if match:
                        package = match.group(1).lower()
                        pkg_version = match.group(2)
                        dependencies[package] = pkg_version
        
        except Exception as e:
            print(f"[Error] Cannot read requirements file: {e}")
        
        return dependencies
    
    def _check_known_vulnerability(self, package, current_version):
        """ตรวจสอบว่ามี known vulnerability หรือไม่"""
        
        # เช็คใน known vulnerabilities
        if package in self.known_vulnerabilities:
            if current_version in self.known_vulnerabilities[package]:
                cve_info = self.known_vulnerabilities[package][current_version]
                print(f"[Deps] ✓ Known vulnerability found in {package}=={current_version}")
                
                return {
                    'type': 'Outdated Dependency - Known Vulnerability',
                    'severity': 'High',
                    'package': package,
                    'current_version': current_version,
                    'vulnerability': cve_info,
                    'description': f'{package}=={current_version} has known security vulnerability: {cve_info}',
                    'recommendation': f'Update {package} to latest secure version immediately'
                }
        
        return None
    
    def _check_outdated(self, package, current_version):
        """ตรวจสอบว่ามีเวอร์ชันใหม่หรือไม่"""
        
        try:
            # เรียก PyPI API
            response = requests.get(self.pypi_api.format(package=package), timeout=5)
            
            if response.status_code != 200:
                return None
            
            data = response.json()
            latest_version = data['info']['version']
            
            # เปรียบเทียบเวอร์ชัน
            if version.parse(current_version) < version.parse(latest_version):
                print(f"[Deps] ✓ Outdated: {package}=={current_version} (latest: {latest_version})")
                
                return {
                    'type': 'Outdated Dependency',
                    'severity': 'Low',
                    'package': package,
                    'current_version': current_version,
                    'latest_version': latest_version,
                    'description': f'{package}=={current_version} is outdated (latest: {latest_version})',
                    'recommendation': f'Update {package} to version {latest_version}'
                }
            else:
                print(f"[Deps] ✗ {package} is up to date")
        
        except Exception as e:
            print(f"[Deps] Warning: Could not check {package}: {e}")
        
        return None


# ทดสอบ scanner
if __name__ == "__main__":
    print("="*50)
    print("Outdated Dependencies Scanner - Test")
    print("="*50)
    
    scanner = OutdatedDepsScanner()
    
    # ทดสอบกับ requirements.txt ของโปรเจก
    results = scanner.scan('requirements.txt')
    
    print("\n" + "="*50)
    print("Results:")
    print("="*50)
    
    if len(results) == 0:
        print("\n✓ All dependencies are up to date and secure")
    else:
        for vuln in results:
            print(f"\n✗ {vuln['type']}")
            print(f"  Package: {vuln['package']}")
            print(f"  Current Version: {vuln['current_version']}")
            if 'latest_version' in vuln:
                print(f"  Latest Version: {vuln['latest_version']}")
            if 'vulnerability' in vuln:
                print(f"  Vulnerability: {vuln['vulnerability']}")
            print(f"  Severity: {vuln['severity']}")
            print(f"  Recommendation: {vuln['recommendation']}")