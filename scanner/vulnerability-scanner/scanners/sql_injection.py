# scanners/sql_injection.py
"""
SQL Injection Scanner
สแกนหา SQL Injection vulnerabilities ใน forms และ URL parameters
"""

import requests
from urllib.parse import urljoin, urlparse, parse_qs
from bs4 import BeautifulSoup


class SQLInjectionScanner:
    def __init__(self):
        """Initialize SQL Injection Scanner"""
        # โหลด payloads จากไฟล์
        self.payloads = self._load_payloads()
        
        # SQL error messages ที่บ่งบอกว่ามีช่องโหว่
        self.error_messages = [
            "SQL syntax",
            "mysql_fetch",
            "ORA-",
            "PostgreSQL",
            "SQLite",
            "Microsoft SQL",
            "Unclosed quotation mark",
            "quoted string not properly terminated",
            "syntax error",
            "mysql_num_rows",
            "mysqli",
            "SQL command not properly ended"
        ]
    
    def _load_payloads(self):
        """โหลด SQL payloads จากไฟล์"""
        try:
            with open('payloads/sql_payloads.txt', 'r') as f:
                payloads = [line.strip() for line in f.readlines() if line.strip()]
            print(f"[SQL] Loaded {len(payloads)} payloads")
            return payloads
        except FileNotFoundError:
            print("[SQL] Warning: sql_payloads.txt not found, using default payloads")
            # Default payloads ถ้าไฟล์ไม่เจอ
            return [
                "' OR '1'='1",
                "' OR '1'='1' --",
                "admin' --",
                "' OR 1=1 --"
            ]
    
    def scan(self, url):
        """
        สแกนหา SQL Injection vulnerabilities
        
        Args:
            url (str): URL ที่จะสแกน
            
        Returns:
            list: รายการช่องโหว่ที่พบ
        """
        vulnerabilities = []
        
        print(f"\n[SQL Injection] Scanning {url}...")
        
        try:
            # 1. หา forms ในหน้าเว็บ
            forms = self._get_forms(url)
            print(f"[SQL Injection] Found {len(forms)} forms")
            
            # 2. ทดสอบแต่ละ form
            for i, form in enumerate(forms):
                print(f"[SQL Injection] Testing form {i+1}/{len(forms)}...")
                vulns = self._test_form(url, form)
                vulnerabilities.extend(vulns)
            
            # 3. ทดสอบ URL parameters (ถ้ามี)
            if '?' in url:
                print(f"[SQL Injection] Testing URL parameters...")
                vulns = self._test_url_params(url)
                vulnerabilities.extend(vulns)
            
            print(f"[SQL Injection] Found {len(vulnerabilities)} vulnerabilities")
            
        except Exception as e:
            print(f"[SQL Injection] Error: {e}")
        
        return vulnerabilities
    
    def _get_forms(self, url):
        """ดึง HTML forms จากหน้าเว็บ"""
        try:
            response = requests.get(url, timeout=10)
            soup = BeautifulSoup(response.content, 'html.parser')
            return soup.find_all('form')
        except Exception as e:
            print(f"[Error] Cannot get forms: {e}")
            return []
    
    def _test_form(self, url, form):
        """ทดสอบ form ด้วย SQL payloads"""
        vulnerabilities = []
        
        # ดึง action และ method
        action = form.get('action')
        method = form.get('method', 'get').lower()
        
        # สร้าง full URL
        target_url = urljoin(url, action) if action else url
        
        # ดึง input fields
        inputs = form.find_all(['input', 'textarea', 'select'])
        
        # ลอง payload แต่ละตัว
        for payload in self.payloads:
            # สร้าง data สำหรับส่ง
            data = {}
            for input_tag in inputs:
                name = input_tag.get('name')
                if name:
                    # ใส่ payload ใน field ที่มี name
                    if input_tag.get('type') != 'submit':
                        data[name] = payload
            
            if not data:
                continue
            
            # ส่ง request
            try:
                if method == 'post':
                    response = requests.post(target_url, data=data, timeout=10)
                else:
                    response = requests.get(target_url, params=data, timeout=10)
                
                # ตรวจสอบ response
                if self._check_sql_error(response.text):
                    vulnerabilities.append({
                        'type': 'SQL Injection',
                        'severity': 'High',
                        'url': target_url,
                        'method': method.upper(),
                        'payload': payload,
                        'description': f'SQL error found when testing form with payload: {payload}'
                    })
                    print(f"[SQL Injection] ✓ Vulnerability found! Payload: {payload}")
                    break  # เจอแล้วไม่ต้องทดสอบ payload อื่น
                    
            except Exception as e:
                print(f"[Error] Testing form failed: {e}")
        
        return vulnerabilities
    
    def _test_url_params(self, url):
        """ทดสอบ URL parameters"""
        vulnerabilities = []
        
        parsed = urlparse(url)
        params = parse_qs(parsed.query)
        
        # ทดสอบแต่ละ parameter
        for param_name in params.keys():
            for payload in self.payloads:
                # สร้าง URL ใหม่ที่มี payload
                test_params = params.copy()
                test_params[param_name] = [payload]
                
                # สร้าง URL ใหม่
                test_url = f"{parsed.scheme}://{parsed.netloc}{parsed.path}"
                
                try:
                    response = requests.get(test_url, params=test_params, timeout=10)
                    
                    if self._check_sql_error(response.text):
                        vulnerabilities.append({
                            'type': 'SQL Injection',
                            'severity': 'High',
                            'url': url,
                            'parameter': param_name,
                            'payload': payload,
                            'description': f'SQL error found in URL parameter: {param_name}'
                        })
                        print(f"[SQL Injection] ✓ Vulnerability found in param '{param_name}'! Payload: {payload}")
                        break
                        
                except Exception as e:
                    print(f"[Error] Testing URL params failed: {e}")
        
        return vulnerabilities
    
    def _check_sql_error(self, response_text):
        """ตรวจสอบว่ามี SQL error messages หรือไม่"""
        response_lower = response_text.lower()
        for error_msg in self.error_messages:
            if error_msg.lower() in response_lower:
                return True
        return False


# ทดสอบ scanner
if __name__ == "__main__":
    print("="*50)
    print("SQL Injection Scanner - Test")
    print("="*50)
    
    scanner = SQLInjectionScanner()
    
    # ทดสอบกับ vulnerable site (ปลอดภัย สำหรับทดสอบ)
    test_url = "http://testphp.vulnweb.com/listproducts.php?cat=1"
    
    results = scanner.scan(test_url)
    
    print("\n" + "="*50)
    print("Results:")
    print("="*50)
    for vuln in results:
        print(f"\n✗ {vuln['type']}")
        print(f"  URL: {vuln['url']}")
        print(f"  Severity: {vuln['severity']}")
        print(f"  Payload: {vuln['payload']}")