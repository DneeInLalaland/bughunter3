# scanners/auth_flaws.py
"""
Authentication Flaws Scanner
ตรวจสอบช่องโหว่ด้าน authentication เช่น weak passwords, default credentials
"""

import requests
from urllib.parse import urljoin
from bs4 import BeautifulSoup
import time


class AuthFlawsScanner:
    def __init__(self):
        """Initialize Auth Flaws Scanner"""
        # Common default credentials
        self.default_credentials = [
            ('admin', 'admin'),
            ('admin', 'password'),
            ('admin', '123456'),
            ('admin', 'admin123'),
            ('root', 'root'),
            ('root', 'password'),
            ('user', 'user'),
            ('test', 'test'),
            ('guest', 'guest')
        ]
    
    def scan(self, url):
        """
        สแกนหา Authentication vulnerabilities
        
        Args:
            url (str): URL ที่จะสแกน
            
        Returns:
            list: รายการช่องโหว่ที่พบ
        """
        vulnerabilities = []
        
        print(f"\n[Auth] Scanning {url}...")
        
        try:
            # 1. หา login forms
            forms = self._get_login_forms(url)
            print(f"[Auth] Found {len(forms)} potential login forms")
            
            # 2. ทดสอบแต่ละ form
            for i, form in enumerate(forms):
                print(f"[Auth] Testing form {i+1}/{len(forms)}...")
                
                # 2.1 ทดสอบ default credentials
                vuln = self._test_default_credentials(url, form)
                if vuln:
                    vulnerabilities.append(vuln)
                
                # 2.2 ตรวจสอบ rate limiting
                vuln = self._check_rate_limiting(url, form)
                if vuln:
                    vulnerabilities.append(vuln)
            
            print(f"[Auth] Found {len(vulnerabilities)} vulnerabilities")
            
        except Exception as e:
            print(f"[Auth] Error: {e}")
        
        return vulnerabilities
    
    def _get_login_forms(self, url):
        """หา login forms จากหน้าเว็บ"""
        try:
            response = requests.get(url, timeout=10)
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # หา forms ทั้งหมด
            all_forms = soup.find_all('form')
            login_forms = []
            
            # กรอง forms ที่น่าจะเป็น login form
            for form in all_forms:
                # ดู input fields
                inputs = form.find_all('input')
                has_password = False
                has_username = False
                
                for inp in inputs:
                    input_type = inp.get('type', '').lower()
                    input_name = inp.get('name', '').lower()
                    
                    if input_type == 'password':
                        has_password = True
                    
                    if any(name in input_name for name in ['user', 'email', 'login', 'account']):
                        has_username = True
                
                # ถ้ามีทั้ง username และ password field = login form
                if has_password and has_username:
                    login_forms.append(form)
            
            return login_forms
            
        except Exception as e:
            print(f"[Error] Cannot get forms: {e}")
            return []
    
    def _test_default_credentials(self, url, form):
        """ทดสอบ default credentials"""
        print(f"[Auth] Testing default credentials...")
        
        # ดึง action และ method
        action = form.get('action')
        method = form.get('method', 'post').lower()
        
        # สร้าง full URL
        target_url = urljoin(url, action) if action else url
        
        # หา username และ password fields
        inputs = form.find_all('input')
        username_field = None
        password_field = None
        
        for inp in inputs:
            input_type = inp.get('type', '').lower()
            input_name = inp.get('name', '')
            
            if input_type == 'password':
                password_field = input_name
            elif any(name in input_name.lower() for name in ['user', 'email', 'login', 'account']):
                username_field = input_name
        
        if not username_field or not password_field:
            print(f"[Auth] Could not identify username/password fields")
            return None
        
        # ลอง default credentials แต่ละตัว (จำกัด 3 ตัวแรกเพื่อประหยัดเวลา)
        for username, password in self.default_credentials[:3]:
            data = {
                username_field: username,
                password_field: password
            }
            
            try:
                if method == 'post':
                    response = requests.post(target_url, data=data, timeout=10, allow_redirects=False)
                else:
                    response = requests.get(target_url, params=data, timeout=10, allow_redirects=False)
                
                # ตรวจสอบว่า login สำเร็จหรือไม่
                # (นี่เป็นการเดาแบบง่ายๆ อาจไม่แม่นยำ 100%)
                if self._check_login_success(response):
                    return {
                        'type': 'Weak Authentication - Default Credentials',
                        'severity': 'High',
                        'url': target_url,
                        'credentials': f'{username}/{password}',
                        'description': f'Login successful with default credentials: {username}/{password}',
                        'recommendation': 'Change default credentials immediately'
                    }
                
                # รอ 0.5 วินาทีระหว่างแต่ละครั้ง
                time.sleep(0.5)
                
            except Exception as e:
                print(f"[Error] Testing credentials failed: {e}")
        
        print(f"[Auth] No default credentials found")
        return None
    
    def _check_login_success(self, response):
        """ตรวจสอบว่า login สำเร็จหรือไม่"""
        # วิธีเดา (ไม่แม่นยำ 100%):
        # 1. ถ้า redirect (302, 301) = อาจ login สำเร็จ
        # 2. ถ้า status 200 และไม่มีคำว่า "error", "invalid", "incorrect" = อาจ login สำเร็จ
        
        if response.status_code in [301, 302, 303]:
            # Redirect = อาจ login สำเร็จ
            return True
        
        response_text = response.text.lower()
        
        # ถ้ามีคำว่า error/invalid = login ไม่สำเร็จ
        error_keywords = ['error', 'invalid', 'incorrect', 'wrong', 'failed', 'denied']
        if any(keyword in response_text for keyword in error_keywords):
            return False
        
        # ถ้ามีคำว่า welcome/dashboard/logout = login สำเร็จ
        success_keywords = ['welcome', 'dashboard', 'logout', 'profile']
        if any(keyword in response_text for keyword in success_keywords):
            return True
        
        return False
    
    def _check_rate_limiting(self, url, form):
        """ตรวจสอบว่ามี rate limiting หรือไม่"""
        print(f"[Auth] Checking rate limiting...")
        
        # ดึง action และ method
        action = form.get('action')
        method = form.get('method', 'post').lower()
        
        # สร้าง full URL
        target_url = urljoin(url, action) if action else url
        
        # หา username และ password fields
        inputs = form.find_all('input')
        username_field = None
        password_field = None
        
        for inp in inputs:
            input_type = inp.get('type', '').lower()
            input_name = inp.get('name', '')
            
            if input_type == 'password':
                password_field = input_name
            elif any(name in input_name.lower() for name in ['user', 'email', 'login', 'account']):
                username_field = input_name
        
        if not username_field or not password_field:
            return None
        
        # ลอง login 5 ครั้งติดๆ กัน
        data = {
            username_field: 'testuser',
            password_field: 'wrongpassword'
        }
        
        blocked = False
        
        try:
            for i in range(5):
                if method == 'post':
                    response = requests.post(target_url, data=data, timeout=10)
                else:
                    response = requests.get(target_url, params=data, timeout=10)
                
                # ตรวจสอบว่าถูก block หรือไม่
                if response.status_code == 429 or 'rate limit' in response.text.lower() or 'too many' in response.text.lower():
                    blocked = True
                    break
                
                time.sleep(0.2)
            
            if not blocked:
                print(f"[Auth] ✓ No rate limiting detected!")
                return {
                    'type': 'Weak Authentication - No Rate Limiting',
                    'severity': 'Medium',
                    'url': target_url,
                    'description': 'Login form does not implement rate limiting, allowing brute force attacks',
                    'recommendation': 'Implement rate limiting and account lockout after multiple failed attempts'
                }
            else:
                print(f"[Auth] ✗ Rate limiting is active")
                
        except Exception as e:
            print(f"[Error] Rate limiting check failed: {e}")
        
        return None


# ทดสอบ scanner
if __name__ == "__main__":
    print("="*50)
    print("Auth Flaws Scanner - Test")
    print("="*50)
    
    scanner = AuthFlawsScanner()
    
    # ทดสอบกับ vulnerable site (ปลอดภัย สำหรับทดสอบ)
    test_url = "http://testphp.vulnweb.com/userinfo.php"
    
    results = scanner.scan(test_url)
    
    print("\n" + "="*50)
    print("Results:")
    print("="*50)
    
    if len(results) == 0:
        print("\n✓ No authentication vulnerabilities found")
    else:
        for vuln in results:
            print(f"\n✗ {vuln['type']}")
            print(f"  URL: {vuln['url']}")
            print(f"  Severity: {vuln['severity']}")
            print(f"  Description: {vuln['description']}")
            print(f"  Recommendation: {vuln['recommendation']}")