# scanners/xss.py
"""
XSS (Cross-Site Scripting) Scanner
สแกนหา XSS vulnerabilities ใน forms และ URL parameters
"""

import requests
from urllib.parse import urljoin, urlparse, parse_qs
from bs4 import BeautifulSoup
import re


class XSSScanner:
    def __init__(self):
        """Initialize XSS Scanner"""
        # โหลด payloads จากไฟล์
        self.payloads = self._load_payloads()
    
    def _load_payloads(self):
        """โหลด XSS payloads จากไฟล์"""
        try:
            with open('payloads/xss_payloads.txt', 'r') as f:
                payloads = [line.strip() for line in f.readlines() if line.strip()]
            print(f"[XSS] Loaded {len(payloads)} payloads")
            return payloads
        except FileNotFoundError:
            print("[XSS] Warning: xss_payloads.txt not found, using default payloads")
            # Default payloads ถ้าไฟล์ไม่เจอ
            return [
                "<script>alert('XSS')</script>",
                "<img src=x onerror=alert('XSS')>",
                "<svg onload=alert('XSS')>",
                "';alert('XSS');//"
            ]
    
    def scan(self, url):
        """
        สแกนหา XSS vulnerabilities
        
        Args:
            url (str): URL ที่จะสแกน
            
        Returns:
            list: รายการช่องโหว่ที่พบ
        """
        vulnerabilities = []
        
        print(f"\n[XSS] Scanning {url}...")
        
        try:
            # 1. หา forms ในหน้าเว็บ
            forms = self._get_forms(url)
            print(f"[XSS] Found {len(forms)} forms")
            
            # 2. ทดสอบแต่ละ form
            for i, form in enumerate(forms):
                print(f"[XSS] Testing form {i+1}/{len(forms)}...")
                vulns = self._test_form(url, form)
                vulnerabilities.extend(vulns)
            
            # 3. ทดสอบ URL parameters (ถ้ามี)
            if '?' in url:
                print(f"[XSS] Testing URL parameters...")
                vulns = self._test_url_params(url)
                vulnerabilities.extend(vulns)
            
            print(f"[XSS] Found {len(vulnerabilities)} vulnerabilities")
            
        except Exception as e:
            print(f"[XSS] Error: {e}")
        
        return vulnerabilities
    
    def _get_forms(self, url):
        """ดึง HTML forms จากหน้าเว็บ"""
        try:
            response = requests.get(url, timeout=10)
            soup = BeautifulSoup(response.content, 'html.parser')
            return soup.find_all('form')
        except Exception as e:
            print(f"[Error] Cannot get forms: {e}")
            return []
    
    def _test_form(self, url, form):
        """ทดสอบ form ด้วย XSS payloads"""
        vulnerabilities = []
        
        # ดึง action และ method
        action = form.get('action')
        method = form.get('method', 'get').lower()
        
        # สร้าง full URL
        target_url = urljoin(url, action) if action else url
        
        # ดึง input fields (เฉพาะ input และ textarea)
        inputs = form.find_all(['input', 'textarea'])
        
        # ลอง payload แต่ละตัว
        for payload in self.payloads:
            # สร้าง data สำหรับส่ง
            data = {}
            for input_tag in inputs:
                name = input_tag.get('name')
                if name and input_tag.get('type') != 'submit':
                    data[name] = payload
            
            if not data:
                continue
            
            # ส่ง request
            try:
                if method == 'post':
                    response = requests.post(target_url, data=data, timeout=10)
                else:
                    response = requests.get(target_url, params=data, timeout=10)
                
                # ตรวจสอบว่า payload ถูก reflect กลับมาหรือไม่
                if self._check_reflected(response.text, payload):
                    vulnerabilities.append({
                        'type': 'Cross-Site Scripting (XSS)',
                        'severity': 'Medium',
                        'url': target_url,
                        'method': method.upper(),
                        'payload': payload,
                        'description': f'XSS payload reflected in response without sanitization'
                    })
                    print(f"[XSS] ✓ Vulnerability found! Payload: {payload[:50]}...")
                    break  # เจอแล้วไม่ต้องทดสอบ payload อื่น
                    
            except Exception as e:
                print(f"[Error] Testing form failed: {e}")
        
        return vulnerabilities
    
    def _test_url_params(self, url):
        """ทดสอบ URL parameters"""
        vulnerabilities = []
        
        parsed = urlparse(url)
        params = parse_qs(parsed.query)
        
        # ทดสอบแต่ละ parameter
        for param_name in params.keys():
            for payload in self.payloads:
                # สร้าง URL ใหม่ที่มี payload
                test_params = params.copy()
                test_params[param_name] = [payload]
                
                # สร้าง URL ใหม่
                test_url = f"{parsed.scheme}://{parsed.netloc}{parsed.path}"
                
                try:
                    response = requests.get(test_url, params=test_params, timeout=10)
                    
                    if self._check_reflected(response.text, payload):
                        vulnerabilities.append({
                            'type': 'Cross-Site Scripting (XSS)',
                            'severity': 'Medium',
                            'url': url,
                            'parameter': param_name,
                            'payload': payload,
                            'description': f'XSS vulnerability in URL parameter: {param_name}'
                        })
                        print(f"[XSS] ✓ Vulnerability found in param '{param_name}'! Payload: {payload[:50]}...")
                        break
                        
                except Exception as e:
                    print(f"[Error] Testing URL params failed: {e}")
        
        return vulnerabilities
    
    def _check_reflected(self, response_text, payload):
        """
        ตรวจสอบว่า payload ถูก reflect กลับมาโดยไม่มี sanitization
        
        ถ้าเจอ payload ตัวเดิมใน response = มีช่องโหว่
        ถ้า payload ถูก encode/escape = ปลอดภัย
        """
        # เช็คว่า payload อยู่ใน response แบบตรงๆ
        if payload in response_text:
            return True
        
        # เช็คว่า payload อยู่แต่อาจมี whitespace
        payload_normalized = re.sub(r'\s+', '', payload)
        response_normalized = re.sub(r'\s+', '', response_text)
        
        if payload_normalized in response_normalized:
            return True
        
        return False


# ทดสอบ scanner
if __name__ == "__main__":
    print("="*50)
    print("XSS Scanner - Test")
    print("="*50)
    
    scanner = XSSScanner()
    
    # ทดสอบกับ vulnerable site (ปลอดภัย สำหรับทดสอบ)
    test_url = "http://testphp.vulnweb.com/search.php?test=query"
    
    results = scanner.scan(test_url)
    
    print("\n" + "="*50)
    print("Results:")
    print("="*50)
    for vuln in results:
        print(f"\n✗ {vuln['type']}")
        print(f"  URL: {vuln['url']}")
        print(f"  Severity: {vuln['severity']}")
        print(f"  Payload: {vuln['payload']}")