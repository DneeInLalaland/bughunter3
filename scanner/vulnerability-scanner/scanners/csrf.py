# scanners/csrf.py
"""
CSRF (Cross-Site Request Forgery) Scanner
ตรวจสอบว่า forms และ endpoints มีการป้องกัน CSRF หรือไม่
"""

import requests
from urllib.parse import urljoin
from bs4 import BeautifulSoup


class CSRFScanner:
    def __init__(self):
        """Initialize CSRF Scanner"""
        # CSRF token names ที่มักใช้กัน
        self.csrf_token_names = [
            'csrf_token',
            'csrf',
            '_csrf',
            'csrftoken',
            'token',
            '_token',
            'authenticity_token',
            'anti_csrf_token',
            'xsrf_token',
            'xsrf-token'
        ]
    
    def scan(self, url):
        """
        สแกนหา CSRF vulnerabilities
        
        Args:
            url (str): URL ที่จะสแกน
            
        Returns:
            list: รายการช่องโหว่ที่พบ
        """
        vulnerabilities = []
        
        print(f"\n[CSRF] Scanning {url}...")
        
        try:
            # 1. หา forms ในหน้าเว็บ
            forms = self._get_forms(url)
            print(f"[CSRF] Found {len(forms)} forms")
            
            # 2. ตรวจสอบแต่ละ form
            for i, form in enumerate(forms):
                print(f"[CSRF] Checking form {i+1}/{len(forms)}...")
                vulns = self._check_form_csrf(url, form)
                vulnerabilities.extend(vulns)
            
            print(f"[CSRF] Found {len(vulnerabilities)} vulnerabilities")
            
        except Exception as e:
            print(f"[CSRF] Error: {e}")
        
        return vulnerabilities
    
    def _get_forms(self, url):
        """ดึง HTML forms จากหน้าเว็บ"""
        try:
            response = requests.get(url, timeout=10)
            soup = BeautifulSoup(response.content, 'html.parser')
            return soup.find_all('form')
        except Exception as e:
            print(f"[Error] Cannot get forms: {e}")
            return []
    
    def _check_form_csrf(self, url, form):
        """ตรวจสอบว่า form มี CSRF protection หรือไม่"""
        vulnerabilities = []
        
        # ดึง action และ method
        action = form.get('action')
        method = form.get('method', 'get').lower()
        
        # สร้าง full URL
        target_url = urljoin(url, action) if action else url
        
        # เฉพาะ POST/PUT/DELETE forms ถึงต้องมี CSRF token
        if method not in ['post', 'put', 'delete']:
            print(f"[CSRF] Form uses {method.upper()} - CSRF check skipped")
            return vulnerabilities
        
        # ตรวจสอบว่ามี CSRF token หรือไม่
        has_csrf_token = self._form_has_csrf_token(form)
        
        if not has_csrf_token:
            # ไม่มี CSRF token = มีช่องโหว่!
            vulnerabilities.append({
                'type': 'CSRF (Cross-Site Request Forgery)',
                'severity': 'Medium',
                'url': target_url,
                'method': method.upper(),
                'description': 'Form does not have CSRF token protection',
                'recommendation': 'Add CSRF token to form to prevent CSRF attacks'
            })
            print(f"[CSRF] ✓ Vulnerability found! No CSRF token in {method.upper()} form")
        else:
            print(f"[CSRF] ✗ Form has CSRF protection")
        
        return vulnerabilities
    
    def _form_has_csrf_token(self, form):
        """ตรวจสอบว่า form มี CSRF token หรือไม่"""
        # หา input fields ทั้งหมด
        inputs = form.find_all('input')
        
        for input_tag in inputs:
            input_name = input_tag.get('name', '').lower()
            input_type = input_tag.get('type', '').lower()
            
            # ตรวจสอบว่า input name ตรงกับ CSRF token names
            for token_name in self.csrf_token_names:
                if token_name in input_name:
                    print(f"[CSRF] Found CSRF token: {input_tag.get('name')}")
                    return True
            
            # ตรวจสอบ hidden input ที่อาจเป็น token
            if input_type == 'hidden':
                input_value = input_tag.get('value', '')
                # ถ้า value ยาวกว่า 20 ตัวอักษร อาจเป็น token
                if len(input_value) > 20:
                    print(f"[CSRF] Found potential CSRF token (hidden input with long value)")
                    return True
        
        # ตรวจสอบ meta tags (บาง framework ใช้ meta tag)
        meta_tags = form.find_all('meta')
        for meta in meta_tags:
            meta_name = meta.get('name', '').lower()
            for token_name in self.csrf_token_names:
                if token_name in meta_name:
                    print(f"[CSRF] Found CSRF token in meta tag: {meta.get('name')}")
                    return True
        
        return False


# ทดสอบ scanner
if __name__ == "__main__":
    print("="*50)
    print("CSRF Scanner - Test")
    print("="*50)
    
    scanner = CSRFScanner()
    
    # ทดสอบกับ vulnerable site (ปลอดภัย สำหรับทดสอบ)
    test_url = "http://testphp.vulnweb.com/login.php"
    
    results = scanner.scan(test_url)
    
    print("\n" + "="*50)
    print("Results:")
    print("="*50)
    
    if len(results) == 0:
        print("\n✓ No CSRF vulnerabilities found (all forms have protection)")
    else:
        for vuln in results:
            print(f"\n✗ {vuln['type']}")
            print(f"  URL: {vuln['url']}")
            print(f"  Method: {vuln['method']}")
            print(f"  Severity: {vuln['severity']}")
            print(f"  Description: {vuln['description']}")
            print(f"  Recommendation: {vuln['recommendation']}")