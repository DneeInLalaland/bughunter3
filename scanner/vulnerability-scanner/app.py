# app.py
"""
Vulnerability Scanner API
Main API ‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° Scanners ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
"""

from flask import Flask, jsonify, request
from flask_cors import CORS

# Import scanners
from scanners.sql_injection import SQLInjectionScanner
from scanners.xss import XSSScanner
from scanners.csrf import CSRFScanner
from scanners.auth_flaws import AuthFlawsScanner
from scanners.outdated_deps import OutdatedDepsScanner
from scanners.port_scanner import PortScanner
from scanners.ssl_checker import SSLChecker

app = Flask(__name__)
CORS(app)

# Initialize scanners
sql_scanner = SQLInjectionScanner()
xss_scanner = XSSScanner()
csrf_scanner = CSRFScanner()
auth_scanner = AuthFlawsScanner()
deps_scanner = OutdatedDepsScanner()
port_scanner = PortScanner()
ssl_checker = SSLChecker()


@app.route('/')
def home():
    """API information"""
    return jsonify({
        'name': 'Vulnerability Scanner API',
        'version': '1.0',
        'status': 'ok',
        'scanners': {
            'sql_injection': 'SQL Injection Scanner',
            'xss': 'Cross-Site Scripting Scanner',
            'csrf': 'CSRF Scanner',
            'auth_flaws': 'Authentication Flaws Scanner',
            'outdated_deps': 'Outdated Dependencies Scanner',
            'port_scanner': 'Port Scanner',
            'ssl_checker': 'SSL/TLS Checker'
        },
        'endpoints': {
            '/': 'GET - API info',
            '/health': 'GET - Health check',
            '/scan/sql': 'POST - SQL Injection scan',
            '/scan/xss': 'POST - XSS scan',
            '/scan/csrf': 'POST - CSRF scan',
            '/scan/auth': 'POST - Auth Flaws scan',
            '/scan/deps': 'POST - Dependencies scan',
            '/scan/ports': 'POST - Port scan',
            '/scan/ssl': 'POST - SSL/TLS check',
            '/scan/all': 'POST - Run all scanners'
        }
    })


@app.route('/health')
def health():
    """Health check"""
    return jsonify({
        'status': 'healthy',
        'message': 'All scanners are ready'
    })


@app.route('/scan/sql', methods=['POST'])
def scan_sql():
    """SQL Injection scan endpoint"""
    try:
        data = request.get_json()
        url = data.get('url')
        
        if not url:
            return jsonify({'error': 'URL is required'}), 400
        
        print(f"\n[API] Starting SQL Injection scan for {url}")
        results = sql_scanner.scan(url)
        
        return jsonify({
            'scanner': 'SQL Injection',
            'url': url,
            'vulnerabilities_found': len(results),
            'vulnerabilities': results
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/scan/xss', methods=['POST'])
def scan_xss():
    """XSS scan endpoint"""
    try:
        data = request.get_json()
        url = data.get('url')
        
        if not url:
            return jsonify({'error': 'URL is required'}), 400
        
        print(f"\n[API] Starting XSS scan for {url}")
        results = xss_scanner.scan(url)
        
        return jsonify({
            'scanner': 'XSS',
            'url': url,
            'vulnerabilities_found': len(results),
            'vulnerabilities': results
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/scan/csrf', methods=['POST'])
def scan_csrf():
    """CSRF scan endpoint"""
    try:
        data = request.get_json()
        url = data.get('url')
        
        if not url:
            return jsonify({'error': 'URL is required'}), 400
        
        print(f"\n[API] Starting CSRF scan for {url}")
        results = csrf_scanner.scan(url)
        
        return jsonify({
            'scanner': 'CSRF',
            'url': url,
            'vulnerabilities_found': len(results),
            'vulnerabilities': results
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/scan/auth', methods=['POST'])
def scan_auth():
    """Auth Flaws scan endpoint"""
    try:
        data = request.get_json()
        url = data.get('url')
        
        if not url:
            return jsonify({'error': 'URL is required'}), 400
        
        print(f"\n[API] Starting Auth Flaws scan for {url}")
        results = auth_scanner.scan(url)
        
        return jsonify({
            'scanner': 'Auth Flaws',
            'url': url,
            'vulnerabilities_found': len(results),
            'vulnerabilities': results
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/scan/deps', methods=['POST'])
def scan_deps():
    """Outdated Dependencies scan endpoint"""
    try:
        data = request.get_json()
        requirements_file = data.get('requirements_file', 'requirements.txt')
        
        print(f"\n[API] Starting Dependencies scan")
        results = deps_scanner.scan(requirements_file)
        
        return jsonify({
            'scanner': 'Outdated Dependencies',
            'requirements_file': requirements_file,
            'issues_found': len(results),
            'issues': results
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/scan/ports', methods=['POST'])
def scan_ports():
    """Port scan endpoint"""
    try:
        data = request.get_json()
        url = data.get('url')
        ports = data.get('ports', None)
        
        if not url:
            return jsonify({'error': 'URL is required'}), 400
        
        print(f"\n[API] Starting Port scan for {url}")
        results = port_scanner.scan(url, ports_to_scan=ports)
        
        return jsonify({
            'scanner': 'Port Scanner',
            'url': url,
            'issues_found': len(results),
            'issues': results
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/scan/ssl', methods=['POST'])
def scan_ssl():
    """SSL/TLS check endpoint"""
    try:
        data = request.get_json()
        url = data.get('url')
        
        if not url:
            return jsonify({'error': 'URL is required'}), 400
        
        print(f"\n[API] Starting SSL/TLS check for {url}")
        results = ssl_checker.scan(url)
        
        return jsonify({
            'scanner': 'SSL/TLS Checker',
            'url': url,
            'issues_found': len(results),
            'issues': results
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/scan/all', methods=['POST'])
def scan_all():
    """Run all scanners on a target URL"""
    try:
        data = request.get_json()
        url = data.get('url')
        
        if not url:
            return jsonify({'error': 'URL is required'}), 400
        
        print(f"\n[API] Starting comprehensive scan for {url}")
        print("="*50)
        
        all_results = {
            'url': url,
            'scans_completed': 0,
            'total_vulnerabilities': 0,
            'results': {}
        }
        
        # Run all scanners
        scanners = [
            ('SQL Injection', sql_scanner.scan, url),
            ('XSS', xss_scanner.scan, url),
            ('CSRF', csrf_scanner.scan, url),
            ('Auth Flaws', auth_scanner.scan, url),
            ('Port Scanner', port_scanner.scan, url),
            ('SSL/TLS', ssl_checker.scan, url)
        ]
        
        for scanner_name, scanner_func, scan_url in scanners:
            try:
                results = scanner_func(scan_url)
                all_results['results'][scanner_name] = {
                    'vulnerabilities_found': len(results),
                    'vulnerabilities': results
                }
                all_results['scans_completed'] += 1
                all_results['total_vulnerabilities'] += len(results)
            except Exception as e:
                all_results['results'][scanner_name] = {
                    'error': str(e)
                }
        
        # Add dependencies scan (doesn't need URL)
        try:
            results = deps_scanner.scan('requirements.txt')
            all_results['results']['Outdated Dependencies'] = {
                'issues_found': len(results),
                'issues': results
            }
            all_results['scans_completed'] += 1
            all_results['total_vulnerabilities'] += len(results)
        except Exception as e:
            all_results['results']['Outdated Dependencies'] = {
                'error': str(e)
            }
        
        print("="*50)
        print(f"[API] Comprehensive scan completed!")
        print(f"[API] Total vulnerabilities found: {all_results['total_vulnerabilities']}")
        
        return jsonify(all_results)
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


if __name__ == '__main__':
    print("="*50)
    print("üîç Vulnerability Scanner API")
    print("="*50)
    print("Starting API server...")
    print("API available at: http://localhost:5001")
    print("")
    print("Available Endpoints:")
    print("  GET  /                - API info")
    print("  GET  /health          - Health check")
    print("  POST /scan/sql        - SQL Injection scan")
    print("  POST /scan/xss        - XSS scan")
    print("  POST /scan/csrf       - CSRF scan")
    print("  POST /scan/auth       - Auth Flaws scan")
    print("  POST /scan/deps       - Dependencies scan")
    print("  POST /scan/ports      - Port scan")
    print("  POST /scan/ssl        - SSL/TLS check")
    print("  POST /scan/all        - Run all scanners")
    print("="*50)
    app.run(host='0.0.0.0', port=5001, debug=True)